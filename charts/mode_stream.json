{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": "Mode Share Over Time (Stream Graph)",
  "data": {"url": "https://raw.githubusercontent.com/bryanlje/3179asm2/main/data/arrivals_record.csv"},
  "width": 680,
  "height": 350,
  "params": [
    {"name": "Gender", "value": "All", "bind": {"input": "select", "options": ["All","Male","Female"]}},
    {"name": "From", "value": "2020-01-01", "bind": {"input": "date"}},
    {"name": "To", "value": "2024-12-31", "bind": {"input": "date"}},
    {
      "name": "ModeLegend",
      "select": {"type": "point", "fields": ["type"]},
      "bind": "legend"
    }
  ],
  "transform": [
    {
      "calculate": "Gender === 'Male' ? datum.arrivals_male : (Gender === 'Female' ? datum.arrivals_female : datum.arrivals)",
      "as": "arrivals_sel"
    },
    {"filter": "toDate(datum.date) >= toDate(From) && toDate(datum.date) <= toDate(To)"},
    {
      "lookup": "poe",
      "from": {"data": {"url": "data/points_of_entry.csv"}, "key": "poe", "fields": ["type"]}
    },
    {"timeUnit": "yearmonth", "field": "date", "as": "ym"},
    {
      "aggregate": [{"op": "sum", "field": "arrivals_sel", "as": "arrivals_sum"}],
      "groupby": ["type","ym"]
    },
    {
      "joinaggregate": [{"op": "sum", "field": "arrivals_sum", "as": "month_total"}],
      "groupby": ["ym"]
    },
    {"calculate": "datum.arrivals_sum / datum.month_total", "as": "share"},
    {"filter": {"param": "ModeLegend"}}
  ],
  "mark": {"type": "area", "interpolate": "monotone"},
  "encoding": {
    "x": {"field": "ym", "type": "temporal", "title": null},
    "y": {
      "field": "arrivals_sum",
      "type": "quantitative",
      "stack": "center",
      "title": null
    },
    "color": {"field": "type", "type": "nominal", "title": "Mode"},
    "opacity": {
      "condition": {"param": "ModeLegend", "value": 1},
      "value": 0.2
    },
    "tooltip": [
      {"field": "ym", "type": "temporal", "title": "Month"},
      {"field": "type", "title": "Mode"},
      {"field": "arrivals_sum", "title": "Arrivals", "format": ","},
      {"field": "share", "title": "Share", "format": ".1%"}
    ]
  },
  "config": {
    "axis": {"labelColor": "black", "titleColor": "black"},
    "legend": {"labelColor": "black", "titleColor": "black"},
    "view": {"stroke": "#e6e6e6"}
  }
}
